var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(exports,"__esModule",{value:true});exports.default=void 0;var _objectWithoutProperties2=_interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));var _classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));var _createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));var _defineProperty2=_interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));var _utils=require("./utils");function ownKeys(object,enumerableOnly){var keys=Object.keys(object);if(Object.getOwnPropertySymbols){var symbols=Object.getOwnPropertySymbols(object);if(enumerableOnly)symbols=symbols.filter(function(sym){return Object.getOwnPropertyDescriptor(object,sym).enumerable;});keys.push.apply(keys,symbols);}return keys;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};if(i%2){ownKeys(Object(source),true).forEach(function(key){(0,_defineProperty2.default)(target,key,source[key]);});}else if(Object.getOwnPropertyDescriptors){Object.defineProperties(target,Object.getOwnPropertyDescriptors(source));}else{ownKeys(Object(source)).forEach(function(key){Object.defineProperty(target,key,Object.getOwnPropertyDescriptor(source,key));});}}return target;}function getSharedElements(sceneData,otherSceneData,showing){var sharedElements=sceneData.Component.sharedElements;if(!sharedElements)return null;return(0,_utils.normalizeSharedElementsConfig)(sharedElements(sceneData.route,otherSceneData.route,showing));}var NO_SHARED_ELEMENTS=[];var SharedElementRendererData=function(){function SharedElementRendererData(){(0,_classCallCheck2.default)(this,SharedElementRendererData);(0,_defineProperty2.default)(this,"scenes",[]);(0,_defineProperty2.default)(this,"updateSubscribers",new Set());(0,_defineProperty2.default)(this,"sharedElements",null);(0,_defineProperty2.default)(this,"isShowing",true);(0,_defineProperty2.default)(this,"route",null);(0,_defineProperty2.default)(this,"prevRoute",null);(0,_defineProperty2.default)(this,"routeAnimValue",void 0);(0,_defineProperty2.default)(this,"scene",null);(0,_defineProperty2.default)(this,"prevScene",null);(0,_defineProperty2.default)(this,"sceneAnimValue",void 0);(0,_defineProperty2.default)(this,"isTransitionStarted",false);(0,_defineProperty2.default)(this,"isTransitionClosing",false);(0,_defineProperty2.default)(this,"transitionNavigatorId",'');(0,_defineProperty2.default)(this,"transitionNestingDepth",-1);(0,_defineProperty2.default)(this,"isVerbose",false);}(0,_createClass2.default)(SharedElementRendererData,[{key:"startTransition",value:function startTransition(closing,navigatorId,nestingDepth){if(this.isVerbose)console.debug("startTransition[".concat(navigatorId,"], closing: ").concat(closing,", nestingDepth: ").concat(nestingDepth));if(!this.isTransitionStarted||this.route){this.prevRoute=this.route;this.route=null;this.routeAnimValue=null;if(this.isTransitionStarted){var scene=this.getScene(this.prevRoute);if(scene){this.routeAnimValue=scene.getAnimValue(true);if(this.isVerbose)console.debug("startTransition[".concat(navigatorId,"] using Animated.Value from \"").concat(scene.name,"\", animValue: ").concat(this.routeAnimValue));}}this.isTransitionStarted=true;this.isTransitionClosing=closing;this.transitionNavigatorId=navigatorId;this.transitionNestingDepth=nestingDepth;}else{if(nestingDepth<this.transitionNestingDepth){this.transitionNavigatorId=navigatorId;this.transitionNestingDepth=nestingDepth;}}}},{key:"endTransition",value:function endTransition(closing,navigatorId,nestingDepth){if(this.isVerbose)console.debug("endTransition[".concat(navigatorId,"], closing: ").concat(closing,", nestingDepth: ").concat(nestingDepth));if(!this.isTransitionStarted||this.transitionNavigatorId!==navigatorId){return;}this.isTransitionStarted=false;if(this.prevRoute!=null){this.prevRoute=null;this.routeAnimValue=null;this.updateSceneListeners();this.updateSharedElements();}}},{key:"updateSceneState",value:function updateSceneState(sceneData,route,sceneEvent){switch(sceneEvent){case'willFocus':return this.willFocusScene(sceneData,route);case'didFocus':return this.didFocusScene(sceneData,route);case'willBlur':return this.willBlurScene(sceneData,route);}}},{key:"willFocusScene",value:function willFocusScene(sceneData,route){if(this.isVerbose)console.debug("willFocusScene[".concat(sceneData.navigatorId,"], name: \"").concat(sceneData.name,"\", depth: ").concat(sceneData.nestingDepth));this.registerScene(sceneData,route);if(!this.isTransitionStarted)return;if(!this.isTransitionClosing&&this.prevRoute&&sceneData.navigatorId===this.transitionNavigatorId&&!this.routeAnimValue){this.routeAnimValue=sceneData.getAnimValue(this.isTransitionClosing);if(this.isVerbose)console.debug("willFocusScene[".concat(sceneData.navigatorId,"] using Animated.Value from \"").concat(sceneData.name,"\", animValue: ").concat(this.routeAnimValue));}if(!this.route){this.route=route;}else{var routeScene=this.getScene(this.route);if(routeScene&&routeScene.nestingDepth<=sceneData.nestingDepth){this.route=route;}}if(this.prevRoute&&this.route&&this.routeAnimValue){this.updateSceneListeners();this.updateSharedElements();}}},{key:"didFocusScene",value:function didFocusScene(sceneData,route){if(this.isVerbose)console.debug("didFocusScene[".concat(sceneData.navigatorId,"], name: \"").concat(sceneData.name,"\", depth: ").concat(sceneData.nestingDepth));if(!this.route||this.prevRoute){this.route=route;}else{var routeScene=this.getScene(this.route);if(routeScene&&routeScene.nestingDepth<=sceneData.nestingDepth){this.route=route;}}this.prevRoute=null;this.registerScene(sceneData,route);}},{key:"willBlurScene",value:function willBlurScene(sceneData,route){if(this.isVerbose)console.debug("willBlurScene[".concat(sceneData.navigatorId,"], name: \"").concat(sceneData.name,"\", depth: ").concat(sceneData.nestingDepth));if(!this.isTransitionStarted)return;if(this.isTransitionClosing&&sceneData.navigatorId===this.transitionNavigatorId&&!this.routeAnimValue){this.routeAnimValue=sceneData.getAnimValue(this.isTransitionClosing);if(this.isVerbose)console.debug("willBlurScene[".concat(sceneData.navigatorId,"] using Animated.Value from \"").concat(sceneData.name,"\", animValue: ").concat(this.routeAnimValue));}if(this.prevRoute&&this.route&&this.routeAnimValue){this.updateSceneListeners();this.updateSharedElements();}}},{key:"registerScene",value:function registerScene(sceneData,route){this.scenes.push({scene:sceneData,route:route,subscription:null});if(this.scenes.length>10){var subscription=this.scenes[0].subscription;this.scenes.splice(0,1);if(subscription)subscription();}this.updateSceneListeners();}},{key:"updateSceneListeners",value:function updateSceneListeners(){var _this=this;this.scenes.forEach(function(sceneRoute){var scene=sceneRoute.scene,route=sceneRoute.route,subscription=sceneRoute.subscription;var isActive=_this.route&&_this.route.key===route.key||_this.prevRoute&&_this.prevRoute.key===route.key;if(isActive&&!subscription){sceneRoute.subscription=scene.addUpdateListener(function(){_this.emitUpdateEvent();});}else if(!isActive&&subscription){sceneRoute.subscription=null;subscription();}});}},{key:"getScene",value:function getScene(route){var sceneRoute=route?this.scenes.find(function(sc){return sc.route.key===route.key;}):undefined;return sceneRoute?sceneRoute.scene:null;}},{key:"updateSharedElements",value:function updateSharedElements(){var route=this.route,prevRoute=this.prevRoute,routeAnimValue=this.routeAnimValue;var scene=this.getScene(route);var prevScene=this.getScene(prevRoute);var sceneAnimValue=routeAnimValue;if(scene===this.scene&&prevScene===this.prevScene&&sceneAnimValue===this.sceneAnimValue)return;this.scene=scene;this.prevScene=prevScene;this.sceneAnimValue=sceneAnimValue;var sharedElements=null;var isShowing=true;if(sceneAnimValue&&scene&&prevScene){sharedElements=getSharedElements(scene,prevScene,true);if(!sharedElements){isShowing=false;sharedElements=getSharedElements(prevScene,scene,false);}}if(this.sharedElements!==sharedElements){if(this.isVerbose)console.debug("Transitioning from \"".concat(prevScene===null||prevScene===void 0?void 0:prevScene.name,"\" to \"").concat(scene===null||scene===void 0?void 0:scene.name,"\", elements: ").concat(JSON.stringify(sharedElements)));this.sharedElements=sharedElements;this.isShowing=isShowing;this.emitUpdateEvent();}}},{key:"addUpdateListener",value:function addUpdateListener(handler){var _this2=this;this.updateSubscribers.add(handler);return function(){return _this2.updateSubscribers.delete(handler);};}},{key:"emitUpdateEvent",value:function emitUpdateEvent(){this.updateSubscribers.forEach(function(handler){return handler();});}},{key:"getTransitions",value:function getTransitions(){var sharedElements=this.sharedElements,prevScene=this.prevScene,scene=this.scene,isShowing=this.isShowing,sceneAnimValue=this.sceneAnimValue,route=this.route;if(!sharedElements||!scene||!prevScene||!route)return NO_SHARED_ELEMENTS;return sharedElements.map(function(_ref){var id=_ref.id,otherId=_ref.otherId,other=(0,_objectWithoutProperties2.default)(_ref,["id","otherId"]);var startId=isShowing?otherId||id:id;var endId=isShowing?id:otherId||id;return _objectSpread({key:route.key,position:sceneAnimValue,start:{ancestor:(prevScene?prevScene.getAncestor():undefined)||null,node:(prevScene?prevScene.getNode(startId):undefined)||null},end:{ancestor:(scene?scene.getAncestor():undefined)||null,node:(scene?scene.getNode(endId):undefined)||null}},other);});}},{key:"nestingDepth",get:function get(){return 0;}}]);return SharedElementRendererData;}();exports.default=SharedElementRendererData;
//# sourceMappingURL=SharedElementRendererData.js.map